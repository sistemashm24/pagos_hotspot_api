SISTEMA DE VENTA DE FICHAS POR HOTSPOT - GESTIÓN DE WIFI PAGADO
================================================================================

DESCRIPCIÓN:
Sistema completo para venta de fichas de internet por tiempo en redes WiFi Hotspot 
MikroTik. Integración completa con procesamiento de pagos por tarjeta mediante Conekta.

CARACTERÍSTICAS PRINCIPALES:
1. VENTA DE FICHAS POR HOTSPOT
   - Venta de acceso por tiempo (1h, 24h, 1 semana)
   - Procesamiento instantáneo de pagos
   - Entrega inmediata de credenciales
   - Auto-conexión automática

2. ADMINISTRACIÓN MULTI-USUARIO
   - Super Admin: Gestión completa del sistema de venta de fichas
   - Cliente Admin: Administración por empresa de ventas de fichas
   - Usuario Final: Compra de fichas desde portal WiFi

3. AUTENTICACIÓN DUAL PARA VENTA DE FICHAS
   - Sesiones JWT para portal administrativo de fichas
   - API Keys JWT para portal público de venta de fichas
   - Roles granulares para gestión de ventas

4. PROCESAMIENTO DE PAGOS PARA FICHAS
   - Integración Conekta para venta de fichas por tarjeta
   - Validación doble de transacciones de fichas
   - Sistema automático de rollback en venta de fichas fallida

5. GESTIÓN MIKROTIK PARA VENTA DE FICHAS
   - Creación automática de usuarios al comprar fichas por tarjeta
   - Auto-conexión mediante MAC Cookies en venta de fichas
   - Test de conexión en tiempo real para sistema de fichas
   - Perfiles técnicos de mikrotik mapeados a productos de fichas

6. CATÁLOGO DE FICHAS
   - Fichas personalizables por empresa/router
   - Detalles JSON para fichas vendidas
   - Orden visual de fichas disponibles
   - Fichas destacadas para promociones

ARQUITECTURA:
[Portal Cautivo MikroTik] → [API HotSpot Manager] → [MikroTik Router] → [Internet]
         ↑                            ↑                     ↑
         |                            |                     |
   [Cliente paga]             [Procesa pago]          [Crea usuario]
         |                            |                     |
   [Conekta]                   [PostgreSQL]           [Auto-conexión]

INSTALACIÓN RÁPIDA PARA SISTEMA DE FICHAS:

1. PRERREQUISITOS PARA VENTA DE FICHAS:
   - Python 3.9+ para sistema de fichas
   - PostgreSQL 15+ para registro de ventas de fichas
   - MikroTik RouterOS 6+ para hotspot de fichas
   - Cuenta en Conekta.com para pago de fichas

2. CONFIGURACIÓN DEL SISTEMA DE FICHAS:
   git clone https://github.com/wispremote/hotspot-fichas-manager.git
   cd hotspot-fichas-manager
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   pip install -r requirements.txt
   cp .env.example .env
   # Editar .env con configuración para venta de fichas

3. BASE DE DATOS PARA REGISTRO DE FICHAS:
   createdb bd_fichas_por_tarjeta
   alembic upgrade head

4. INICIAR SERVIDOR DE VENTA DE FICHAS:
   # Desarrollo
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   
   # Producción para venta de fichas
   gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

CONFIGURACIÓN DEL ARCHIVO .env (AJUSTAR SEGÚN TU ENTORNO):

# Base de Datos
DATABASE_URL=postgresql+asyncpg://postgres:xbo@localhost/bd_fichas_por_tarjeta
DATABASE_POOL_SIZE=20

# Secretos JWT (¡CAMBIAR EN PRODUCCIÓN!)
JWT_APIKEY_SECRET=generar_con_openssl_rand_-hex_32
JWT_SESSION_SECRET=generar_con_openssl_rand_-hex_32
JWT_ALGORITHM=HS256
JWT_APIKEY_EXPIRE_DAYS=365
JWT_SESSION_EXPIRE_HOURS=24

# Seguridad
SECRET_KEY=generar_con_openssl_rand_-hex_64
BCRYPT_ROUNDS=12

# CORS
BACKEND_CORS_ORIGINS=["http://localhost:3000", "http://localhost:8080"]

# Admin (¡CAMBIAR EN PRODUCCIÓN!)
SUPER_ADMIN_INITIAL_EMAIL=admin@misistema.com
SUPER_ADMIN_INITIAL_PASSWORD=xbo

# Conekta (solo desarrollo - cambiar a claves reales)
CONEKTA_DEFAULT_PRIVATE_KEY=sk_test_tu_clave_real_aqui
CONEKTA_DEFAULT_PUBLIC_KEY=pk_test_tu_clave_publica_aqui

# App
APP_NAME=Sistema de Venta de Fichas por Hotspot
DEBUG=True

PARA GENERAR SECRETOS SEGUROS EN PRODUCCIÓN:
# Generar claves JWT seguras
openssl rand -hex 32  # Para JWT_APIKEY_SECRET y JWT_SESSION_SECRET
openssl rand -hex 64  # Para SECRET_KEY

ENDPOINTS PRINCIPALES PARA VENTA DE FICHAS:

A) PARA SUPER ADMIN (Backoffice de fichas):
   POST   /admin/empresas                # Crear empresa para venta de fichas
   POST   /admin/empresas/{id}/routers   # Crear router + API Key para fichas
   POST   /admin/usuarios                # Crear administradores de fichas
   GET    /admin/dashboard               # Dashboard global de venta de fichas

B) PARA CLIENTE ADMIN (Panel de fichas):
   GET    /mi-empresa                    # Información de empresa de fichas
   PUT    /mi-empresa/conekta-config     # Configurar Conekta para fichas
   GET    /products                      # Listar fichas disponibles
   POST   /products                      # Crear ficha de venta
   GET    /routers/{id}/mikrotik-profiles # Perfiles para fichas MikroTik

C) PARA USUARIO FINAL (Compra de fichas):
   GET    /config/public                 # Config pública para compra de fichas
   GET    /catalogo_perfiles_venta       # Catálogo de fichas disponibles
   POST   /payments/pagar-conekta        # Procesar pago de ficha

FLUJO COMPLETO DE COMPRA DE FICHAS:

1. Cliente se conecta a la red WiFi con venta de fichas
2. Accede al portal cautivo para comprar fichas
3. Solicita catálogo: GET /catalogo_perfiles_venta
4. Selecciona ficha y paga: POST /payments/pagar-conekta
5. Sistema procesa pago de ficha con Conekta
6. Crea usuario en MikroTik automáticamente (entrega ficha)
7. Si cliente proporcionó MAC, ejecuta auto-conexión por ficha
8. Devuelve credenciales de la ficha al cliente
9. Cliente se conecta automáticamente.

SISTEMA DE API KEYS PARA VENTA DE FICHAS:

- Cada router tiene una API Key JWT única para venta de fichas
- Formato: "jwt_" + token JWT específico para fichas
- Ejemplo: jwt_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
- Validez: 1 año por defecto para sistema de fichas
- Se puede regenerar si se pierde (para no interrumpir venta de fichas)
- Se puede revocar si es comprometida (seguridad en venta de fichas)
- Uso en headers: X-API-Key: jwt_... (para todas las peticiones de fichas)

VARIABLES DE ENTORNO ESENCIALES PARA SISTEMA DE FICHAS:

⚠️ IMPORTANTE: Las siguientes variables DEBEN cambiarse en producción:

1. DATABASE_URL: Mantener como está si usas PostgreSQL local
   DATABASE_URL=postgresql+asyncpg://postgres:xbo@localhost/bd_fichas_por_tarjeta

2. JWT_APIKEY_SECRET: Debe ser una cadena de 32 caracteres hexadecimales
   Ejemplo generado: openssl rand -hex 32 → "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"

3. JWT_SESSION_SECRET: Otra cadena diferente de 32 caracteres
   Ejemplo: openssl rand -hex 32 → "z9y8x7w6v5u4t3s2r1q0p9o8n7m6l5k4j3i2h1g0f9e8d7c6b5a4"

4. SECRET_KEY: Cadena de 64 caracteres hexadecimales
   Ejemplo: openssl rand -hex 64

5. CONEKTA: Cambiar a claves reales de tu cuenta Conekta
   - CONEKTA_DEFAULT_PRIVATE_KEY=sk_live_tuclave32caracteres
   - CONEKTA_DEFAULT_PUBLIC_KEY=pk_live_tuclave32caracteres

AUTO-CONEXIÓN EN VENTA DE FICHAS (MAC COOKIES):

Requisitos para auto-conexión al comprar ficha:
- Cliente debe estar en /ip/hotspot/host del router
- auto_connect: true en la petición de compra de ficha
- mac_address proporcionada al comprar ficha
- Pago de ficha exitoso procesado

Proceso de auto-conexión con ficha:
1. Vincular MAC al usuario de la ficha
2. Crear MAC Cookie en MikroTik para la ficha
3. Ejecutar login automático con la ficha
4. Verificar en sesiones activas la ficha usada

PRUEBAS CON TARJETAS PARA COMPRA DE FICHAS (MODO TEST):

⚠️ Para probar el sistema en modo desarrollo:
1. Usar claves de prueba de Conekta
2. Usar tarjetas de prueba:
   - VISA: 4242 4242 4242 4242
   - MASTERCARD: 5555 5555 5555 4444
   - CVV: 123
   - Fecha: Cualquier fecha futura

3. El sistema viene configurado con:
   CONEKTA_DEFAULT_PRIVATE_KEY=sk_test_default
   CONEKTA_DEFAULT_PUBLIC_KEY=pk_test_default_pub

BACKUP Y RECUPERACIÓN DE DATOS DE FICHAS:

# Backup de base de datos de fichas
pg_dump bd_fichas_por_tarjeta > backup_fichas_$(date +%Y%m%d).sql

# Restaurar backup de venta de fichas
psql bd_fichas_por_tarjeta < backup_fichas_20240101.sql

MODELO DE NEGOCIO DE VENTA DE FICHAS:

CONFIGURACIÓN PORTAL CAUTIVO PARA VENTA DE FICHAS:

1. HTML básico para venta de fichas en MikroTik
2. Integración Conekta.js para pago de fichas
3. Llamadas a los 3 endpoints del sistema de fichas:
   a) GET /config/public → Clave pública para pagos con Conekta
   b) GET /catalogo_perfiles_venta → Lista de fichas
   c) POST /payments/pagar-conekta → Compra de ficha

EJEMPLO DE LLAMADAS PARA VENTA DE FICHAS:

// 1. Obtener configuración para compra de fichas
fetch('https://api.wispremote.com/config/public', {
  headers: { 'X-API-Key': 'API_KEY_VENTA_FICHAS' }
})

// 2. Cargar fichas disponibles
fetch('https://api.wispremote.com/catalogo_perfiles_venta', {
  headers: { 'X-API-Key': 'API_KEY_VENTA_FICHAS' }
})

// 3. Comprar ficha específica
fetch('https://api.wispremote.com/payments/pagar-conekta', {
  method: 'POST',
  headers: { 
    'X-API-Key': 'API_KEY_VENTA_FICHAS',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    product_id: 1,  // ID de la ficha
    card_token: token_tarjeta,
    customer_name: nombre_cliente,
    customer_email: email_cliente,
    mac_address: mac_dispositivo,
    auto_connect: true
  })
})

CONFIGURACIÓN MIKROTIK PARA EL SISTEMA:

1. Crear usuario API en MikroTik:
   /user add name=api-fichas password=xbox group=full

2. Crear perfiles para fichas:
   /ip hotspot profile add name="Ficha_1Hora" session-timeout=1h
   /ip hotspot profile add name="Ficha_24Horas" session-timeout=1d
   /ip hotspot profile add name="Ficha_1Semana" session-timeout=7d

3. Configurar walled-garden para permitir API:
   /ip hotspot walled-garden ip
   add dst-host=api.wispremote.com action=accept
   add dst-host=conekta.com action=accept
   add dst-host=js.conekta.io action=accept

CONTACTO Y SOPORTE PARA SISTEMA DE FICHAS:

- Soporte técnico: soporte@wispremote.com
- Documentación: docs.wispremote.com
- Teléfono: +52 220 331 8661
- Horario: Lunes a Viernes 9:00-18:00

⚠️ RECOMENDACIONES PARA PRODUCCIÓN:

1. CAMBIAR TODAS LAS CLAVES: Generar nuevas con openssl
2. CONFIGURAR HTTPS: Usar certificado SSL válido
3. ACTUALIZAR CONEKTA: Usar claves reales de producción
4. CONFIGURAR FIREWALL: Limitar acceso al puerto 8000
5. HABILITAR BACKUP: Automatizar respaldos diarios
6. MONITOREO: Configurar alertas para el sistema

COMANDOS ÚTILES:

# Crear base de datos
createdb bd_fichas_por_tarjeta

# Ejecutar migraciones
alembic upgrade head

# Crear usuario super admin (se crea automáticamente con variables .env)
# Email: admin@misistema.com
# Password: xbo

# Verificar conexión
curl http://localhost:8000/health

# Acceder a documentación API
http://localhost:8000/docs

VERSIÓN:
2.0.0 - Sistema completo de venta de fichas por hotspot WiFi